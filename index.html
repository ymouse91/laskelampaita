<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
		  		<!-- iOS PWA -liput -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Yleinen v√§riteema (safari, android ym.) -->
<meta name="theme-color" content="#f0f0f0">

<!-- Web manifesti (nimi voi olla my√∂s manifest.json, jos niin olet tehnyt) -->
<link rel="manifest" href="manifest.json">

<!-- iOS:lle pit√§√§ olla erikseen apple-touch-icon -->
<link rel="apple-touch-icon" sizes="192x192" href="./lammas.png">
<title>Counting Sheep</title>


<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    padding: 10px;
    padding-top: calc(env(safe-area-inset-top) + 12px);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}

html, body {
  touch-action: manipulation;
  -webkit-user-select: none;
  user-select: none;
}

.game-title {
    font-size: clamp(20px, 5vw, 32px);
    font-weight: 900;
    color: #333;
    text-align: center;
    margin-bottom: 40px;
    width: 100%;
}

/* --- PERUSLAYOUT --- */

.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    gap: 20px;
}

.sidebar {
    width: 300px;
    max-width: 360px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* --- PELILAUTA --- */

.board-wrapper {
    position: relative;
    width: clamp(320px, 55vw, 700px);
    aspect-ratio: 1 / 1;
}

.game-board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 1px;
    background: #333;
    padding: 5px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    width: 100%;
    height: 100%;
	    margin-top: 20px; /* ‚Äì Uusi rako kulmien ja ruudukon v√§lin */
		    margin-bottom: 20px; /* ‚Äì Uusi rako kulmien ja ruudukon v√§lin */
}

.cell {
    background: #7CB342;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(16px, 8vw, 40px);
    position: relative;
}

.cell.water {
    background: #42A5F5;
}

.piece {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
}

/* --- KULMALABELIT --- */

.corner-label {
    position: absolute;
    font-size: clamp(20px, 3vw, 32px);
    font-weight: 900;
    color: black;
    z-index: 15;
}

.corner-label.tl { top: -36px; left: 0; }
.corner-label.tr { top: -36px; right: 0; text-align:right; }
.corner-label.bl { bottom: -36px; left: 0; }
.corner-label.br { bottom: -36px; right: 0; text-align:right; }

/* --- PALA-VALIKKO --- */

.pieces-container {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	    margin-top: 20px; /* ‚Äì Uusi rako kulmien ja ruudukon v√§lin */
}

.pieces-container h3 { display: none !important; }

/* 2 pienikokoista saraketta */

.piece-selector {
    display: grid;
    grid-template-columns: repeat(2, 120px);
    justify-content: center;
    gap: 12px;
    width: 100%;
}

/* --- YKSI PALA (nappi) --- */

.piece-btn {
    aspect-ratio: 1;
    width: 100%;
    padding: 2px;
    border: 2px solid #ccc;
    border-radius: 6px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    font-size: 0 !important;
}

.piece-btn.selected {
    border-color: #4CAF50;
    background: #e8f5e9;
}

.piece-btn:hover { border-color: #4CAF50; }

.piece-btn.used { opacity: 0.5; }

/* --- 3√ó3 preview--- */

.pieces-container .piece-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    width: 70%;
    aspect-ratio: 1;
    gap: 2px;
    margin: auto;
}

.pieces-container .piece-cell {
    aspect-ratio: 1;
    width: 100%;
    border: 1px solid #888;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    font-size: clamp(10px, 1.8vw, 18px);
}

/* --- NAPIT --- */

.controls {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    margin-bottom: 10px;
}

button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 4px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
}

button:hover { background: #45a049; }
button.reset { background: #666; }

select#difficultySelect{
    flex: 1;
    padding: 10px;
    border: 2px solid #4CAF50;
    border-radius: 4px;
    background: white;
    color: #222;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
}


/* --- STATUS --- */

.status {
    position: absolute;
    bottom: -90px;
    left: 50%;
    transform: translateX(-50%);
    width: 85%;
    padding: 12px;
    background: white;
    border-top: 3px solid #FF9800;
    border-radius: 6px;
    font-size: clamp(14px, 2vw, 20px);
    text-align: center;
    color: #222;
    z-index: 20;
 
}

.status.success {
    border-top-color: #4CAF50;
    background: #e9f7ef;
    color: #1b5e20;
}

/* --- PUHELIMET --- */

@media (max-width: 899px) {
    .container {
        flex-direction: column;
        align-items: center;
    }
    .sidebar {
        width: 100%;
		
        max-width: none;
    }
    .board-wrapper {
        width: clamp(320px, 90vw, 500px);
    }
}

/* --- iPAD / PC --- */

@media (min-width: 900px) {
    .container {
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
    }
    .sidebar {
        width: 320px;
		height: clamp(400px, 55vw, 600px);
        max-width: 300px;
    }
    .board-wrapper {
        width: clamp(400px, 55vw, 500px);
    }
	
}

.cell.occupied {
    position: relative;
}

.cell.occupied::before {
    content: "";
    position: absolute;
    inset: 0;
    background: inherit;
    opacity: 0.35;
    filter: brightness(0.6);
    z-index: 0;
}
.cell.occupied > * {
    position: relative;
    z-index: 1;
}

.piece-grid {
    position: relative;
    z-index: 1;   /* jotta ikonit voivat olla sen p√§√§ll√§ */
}

</style>

</head>
<body>

<div class="game-title"><h1 id="title">üêë Laske lampaita üêë<h1></div>

<div class="container">
<div class="board-wrapper">
<div id="puzzleTitle" 
     style="
         position:absolute;
         top:-36px;
         left:50%;
         transform:translateX(-50%);
         font-size: clamp(20px, 3vw, 32px);
         font-weight: 900;
         white-space: nowrap;
     ">
     Pulma ‚Ä¶
</div>

        <div class="corner-label tl" id="tl">0/?</div>
        <div class="corner-label tr" id="tr">0/?</div>
        <div class="corner-label bl" id="bl">0/?</div>
        <div class="corner-label br" id="br">0/?</div>

        <div class="game-board" id="gameBoard"></div>
		<div class="status" id="status">Ladataan‚Ä¶</div>   
    </div>

    <div class="sidebar">
        <div class="pieces-container">
            <div class="piece-selector" id="pieceSelector"></div>
            <div class="controls">
                <button class="reset" onclick="resetGame()">‚Üª Nollaa</button>

                <select id="difficultySelect" title="Vaikeustaso">
                    <option value="easy">Helppo</option>
                    <option value="normal">Normaali</option>
                    <option value="hard">Hankala</option>
                    <option value="expert">Vaikea</option>
                </select>

                <button onclick="newPuzzle()">Uusi pulma</button>
            </div>
        </div>
    </div>


</div>

<script>
/* -----------------------------
   PIECE DATA
----------------------------- */

const PIECES = {
    1: [[1,1,0],[null,null,0]],
    2: [[2,0],[null,0],[null,0]],
    3: [[0],[1],[2]],
    4: [[1,1]],
    5: [[null,0,1],[0,0,null]],
    6: [[null,0],[2,0]],
    7: [[null,1],[0,0],[null,0]],
    8: [[-1]]
};

const PIECE_NAMES = {1:'P1',2:'P2',3:'P3',4:'P4',5:'P5',6:'P6',7:'P7',8:'Koppi'};

const BOARD_LAYOUT = [
    ['g','g','b','g','g'],
    ['g','g','b','g','g'],
    ['b','b','b','g','g'],
    ['g','g','b','b','b'],
    ['g','g','b','g','g']
];
const AREA_MAP = [
    ['tl','tl','b','tr','tr'],
    ['tl','tl','b','tr','tr'],
    ['b','b','b','tr','tr'],
    ['bl','bl','b','b','b'],
    ['bl','bl','b','br','br']
];


let PUZZLES = [];
let PUZZLE = null;

let gameState = {
    board: Array(25).fill(null),
    selectedPiece: null,
    selectedRotation: 0,
    lockedPieces: new Set()
};

let lastTap = {
    index: null,
    time: 0
};

function isDoubleTap(cellIndex){
    const now = Date.now();

    if (lastTap.index === cellIndex && (now - lastTap.time) < 350) {
        lastTap.index = null;
        lastTap.time = 0;
        return true;
    }

    lastTap.index = cellIndex;
    lastTap.time = now;
    return false;
}

/* ================================================================
   ‚Äì‚Äì‚Äì CATS & BOXES -LOGIIKKA: "findPlacementForClick"
   ================================================================ */

/* Muodostetaan palan "solut" (dx,dy), kuten Cats & Boxes */
function getPieceCells(piece) {
    const out = [];
    for (let r=0;r<piece.length;r++)
        for (let c=0;c<piece[r].length;c++)
            if (piece[r][c] !== null)
                out.push({dx:c, dy:r, value:piece[r][c]});
    return out;
}

/* Etsit√§√§n sijoitus siten, ett√§ klikattu ruutu voi olla mik√§ tahansa palan osa */
function findPlacementForClick(piece, clickRow, clickCol) {
    const cells = getPieceCells(piece);

    // t√§rke√§t solut ensin (koppi, 2-lammas, lammas)
    cells.sort((a,b)=>b.value - a.value);

    for (const cell of cells) {
        const startRow = clickRow - cell.dy;
        const startCol = clickCol - cell.dx;

        if (canPlacePiece(piece, startRow, startCol)) {
            return {ok:true, startRow, startCol};
        }
    }
    return {ok:false};
}
/* ----------------------------------------------------
   PUZZLE LOADING
---------------------------------------------------- */

// --- Vaikeustaso ---
let currentDifficulty = "easy"; // oletus: helppo
let puzzlesLoaded = false;

function getDifficultyRange(){
    // PUZZLES on 0-indeksoitu, mutta UI n√§ytt√§√§ 1..N
    const n = PUZZLES.length;

    if (currentDifficulty === "easy")   return { start: 0,  end: Math.min(11, n-1) };      // 1‚Äì12
    if (currentDifficulty === "normal") return { start: 12, end: Math.min(23, n-1) };      // 13‚Äì24
    if (currentDifficulty === "hard")   return { start: 24, end: Math.min(35, n-1) };      // 25‚Äì36
    return { start: 36, end: n-1 };                                                        // 37 ‚Üí
}

function pickRandomPuzzleIndex(){
    const { start, end } = getDifficultyRange();
    if (end < start) return 0; // varmistus, jos pulmia on v√§hemm√§n kuin odotetaan

    let idx;
    const rangeLen = end - start + 1;

    if (window.lastPuzzleIndex === undefined || rangeLen <= 1){
        idx = start + Math.floor(Math.random() * rangeLen);
    } else {
        do {
            idx = start + Math.floor(Math.random() * rangeLen);
        } while (idx === window.lastPuzzleIndex);
    }
    window.lastPuzzleIndex = idx;
    return idx;
}

function applyRandomPuzzleFromDifficulty(){
    const idx = pickRandomPuzzleIndex();
    PUZZLE = PUZZLES[idx];
    startPuzzle();
}

async function loadPuzzles() {
    try {
        const res = await fetch("counting_sheep_puzzles.json");
        PUZZLES = await res.json();
        puzzlesLoaded = true;
        updateStatus("Pulmatiedosto ladattu!");
        applyRandomPuzzleFromDifficulty();
    } catch (err) {
        console.error(err);
        updateStatus("Pulmatiedoston lataus ep√§onnistui!");
    }
}

function newPuzzle() {
    if (!puzzlesLoaded) {
        loadPuzzles();
        return;
    }
    applyRandomPuzzleFromDifficulty();
}


/* ----------------------------------------------------
   PUZZLE INITIALISATION
---------------------------------------------------- */

function updatePuzzleTitle() {
    const el = document.getElementById("puzzleTitle");
    const name = PUZZLE.name ?? ("Pulma #" + (window.lastPuzzleIndex + 1));
    el.textContent = name;
}

function startPuzzle() {

    // 1) Tyhjenn√§ lukot heti
    gameState.lockedPieces = new Set();

    gameState.board = Array(25).fill(null);
    gameState.selectedPiece = null;
    gameState.selectedRotation = 0;

    // 2) T√§yt√§ lockedPieces ENNEN palojen asettamista
    PUZZLE.prefilled.forEach(p => {
        if (p.locked) gameState.lockedPieces.add(p.piece);
    });

    // 3) Aseta palat laudalle
    PUZZLE.prefilled.forEach(p => {
        const rot = rotatePieceNTimes(PIECES[p.piece], p.rotation);
        placePieceOnBoard(rot, p.row, p.col, p.piece);
    });

    // 4) Render√∂innit
    renderBoard();
    renderPieces();
    updateCorners();
    updatePuzzleTitle();
}


function resetGame() {
    startPuzzle(); // EI arvo uutta pulmaa
}

/* ----------------------------------------------------
   PIECE ROTATION
---------------------------------------------------- */
function rotatePiece() {
    if (!gameState.selectedPiece) {
        updateStatus("Valitse pala, jota haluat k√§√§nt√§√§.");
        return;
    }

    // 1) Kierr√§ rotaatiota
    gameState.selectedRotation = (gameState.selectedRotation + 1) % 4;

    // 2) P√§ivit√§ pelin√§kym√§
    renderPieces();
    updateStatus("Palaa k√§√§nnetty.");
}

function rotatePieceOnce(piece) {
    const rows = piece.length;
    const cols = piece[0].length;
    const rotated = Array(cols).fill(null).map(() => Array(rows).fill(null));
    for (let r=0;r<rows;r++){
        for (let c=0;c<cols;c++){
            rotated[c][rows-1-r] = piece[r][c];
        }
    }
    return rotated;
}

function rotatePieceNTimes(piece, times) {
    let p = JSON.parse(JSON.stringify(piece));
    for (let i=0;i<times;i++) p = rotatePieceOnce(p);
    return p;
}

/* ----------------------------------------------------
   BOARD RENDERING
---------------------------------------------------- */

function renderBoard() {
    const board = document.getElementById('gameBoard');
    board.innerHTML = '';

    for (let i=0;i<25;i++){
        const row = Math.floor(i/5);
        const col = i%5;

        const cell = document.createElement('div');
        let cls = 'cell ' + (BOARD_LAYOUT[row][col] === 'b' ? 'water' : '');
        if (gameState.board[i]) cls += ' occupied';
        cell.className = cls;

cell.onclick = () => {
    const idx = row*5 + col;
    const item = gameState.board[idx];

    // ‚úÖ Kaksoiskosketus ‚Üí poista pala
if (item && isDoubleTap(idx)) {
    // Poistetaan juuri se pala, jota kaksoisklikattiin
    gameState.selectedPiece = item.id;
    gameState.selectedRotation = 0; // palautuu alkuasentoon
    removePiece();                  // k√§ytt√§√§ jo olemassa olevaa poistolokia
    return;
}

    if (item) {
        // ‚ûú Yksi kosketus: valitse pala sivupalkkiin
        gameState.selectedPiece = item.id;
        gameState.selectedRotation = 0;
        renderPieces();
        updateStatus("Pala valittu.");
        return;
    }

    // ‚ûú Tyhj√§ ruutu: yrit√§ asettaa valittu pala
    placeSelectedPiece(row, col);
};



        if (gameState.board[i]) {
            const item = gameState.board[i];
            const div = document.createElement('div');
            div.className = 'piece';

            const top = (row-1)*5+col;
            const bottom = (row+1)*5+col;
            const left = row*5+(col-1);
            const right = row*5+(col+1);

            const hasTop = row>0 && gameState.board[top]?.id === item.id;
            const hasBottom = row<4 && gameState.board[bottom]?.id === item.id;
            const hasLeft = col>0 && gameState.board[left]?.id === item.id;
            const hasRight = col<4 && gameState.board[right]?.id === item.id;

            div.style.borderTop = hasTop ? 'none':'2px solid #333';
            div.style.borderBottom = hasBottom? 'none':'2px solid #333';
            div.style.borderLeft = hasLeft? 'none':'2px solid #333';
            div.style.borderRight = hasRight? 'none':'2px solid #333';

            const isLocked = gameState.lockedPieces.has(item.id);

            if (item.value === -1) {
                div.textContent = 'üè†';
                div.style.background = isLocked ? '#A0826D' : '#8B7355';
            } else if (item.value === 2) {
                div.textContent = 'üêëüêë';
                div.style.fontSize='0.6em';
            } else if (item.value === 1) {
                div.textContent = item.id===5 ? 'üêê' : 'üêë';
            }
            cell.appendChild(div);
        }

        board.appendChild(cell);
    }

    updateCorners();
}

/* ----------------------------------------------------
   CATS & BOXES STYLE PLACEMENT
---------------------------------------------------- */

function isPieceOnBoard(pieceId){
    for (let i=0;i<25;i++){
        if (gameState.board[i] && gameState.board[i].id === pieceId) return true;
    }
    return false;
}


function placeSelectedPiece(clickRow, clickCol){
    if (!gameState.selectedPiece){
        updateStatus("Valitse pala!");
        return;
    }
    // ‚¨á‚¨á‚¨á LIS√Ñ√Ñ T√ÑM√Ñ T√ÑH√ÑN ‚¨á‚¨á‚¨á
    if (gameState.lockedPieces.has(gameState.selectedPiece)) {
        updateStatus("T√§m√§ pala on lukittu eik√§ sit√§ voi asettaa.");
        return;
    }
    // ‚¨Ü‚¨Ü‚¨Ü
	
    // ‚úÖ UUSI: samaa palaa ei voi asettaa toista kertaa, jos se on jo laudalla
    if (isPieceOnBoard(gameState.selectedPiece)) {
        updateStatus("T√§m√§ pala on jo laudalla (poista se ensin).");
        return;
    }

	
    const pieceId = gameState.selectedPiece;
    const piece = rotatePieceNTimes(PIECES[pieceId], gameState.selectedRotation);

    // ‚Äì K√§yt√§ Cats & Boxes -logiikkaa:
    const placement = findPlacementForClick(piece, clickRow, clickCol);

    if (!placement.ok) {
        updateStatus("Palaa ei voi asettaa t√§h√§n.");
        return;
    }

    placePieceOnBoard(piece, placement.startRow, placement.startCol, pieceId);

    renderBoard();
    renderPieces();
    updateStatus("Pala asetettu!");
    checkWin();
}

/* ----------------------------------------------------
   PLACE ON BOARD
---------------------------------------------------- */

function placePieceOnBoard(piece, startRow, startCol, pieceId){
    for (let r=0;r<piece.length;r++){
        for (let c=0;c<piece[r].length;c++){
            if (piece[r][c] === null) continue;
            const idx = (startRow+r)*5 + (startCol+c);
            gameState.board[idx] = { id:pieceId, value:piece[r][c] };
        }
    }
}

/* ----------------------------------------------------
   VALIDATION
---------------------------------------------------- */

function canPlacePiece(piece,startRow,startCol){
    for (let r=0;r<piece.length;r++){
        for (let c=0;c<piece[r].length;c++){
            if (piece[r][c] === null) continue;

            const row = startRow+r;
            const col = startCol+c;

            if (row<0 || row>4 || col<0 || col>4) return false;
            if (piece[r][c]>=1 && BOARD_LAYOUT[row][col]==='b') return false;
            if (gameState.board[row*5+col]) return false;
        }
    }
    return true;
}

/* ----------------------------------------------------
   SIDEBAR RENDERING
---------------------------------------------------- */

function renderPieces(){
    const selector = document.getElementById('pieceSelector');
    selector.innerHTML='';

    const usedPieces = new Set();
    for (let i=0;i<25;i++){
        if (gameState.board[i]) usedPieces.add(gameState.board[i].id);
    }

    for (let i=1;i<=8;i++){
        const btn = document.createElement('button');
        btn.className = 'piece-btn';

        if (gameState.selectedPiece===i) btn.classList.add('selected');

        const piece = gameState.selectedPiece===i ?
            rotatePieceNTimes(PIECES[i],gameState.selectedRotation) :
            PIECES[i];

        // 3√ó3 preview grid
        let minR=99,maxR=-1,minC=99,maxC=-1;
        for (let r=0;r<piece.length;r++)
            for (let c=0;c<piece[r].length;c++)
                if (piece[r][c]!==null){
                    minR=Math.min(minR,r);
                    maxR=Math.max(maxR,r);
                    minC=Math.min(minC,c);
                    maxC=Math.max(maxC,c);
                }

        const offR = Math.floor((3-(maxR-minR+1))/2)-minR;
        const offC = Math.floor((3-(maxC-minC+1))/2)-minC;

        const grid = document.createElement('div');
        grid.className='piece-grid';

        for (let r=0;r<3;r++){
            for (let c=0;c<3;c++){
                const cell=document.createElement('div');
                cell.className='piece-cell';

                const pr=r-offR, pc=c-offC;

                if (pr>=0 && pr<piece.length && pc>=0 && pc<piece[0].length){
                    const val=piece[pr][pc];
                    if (val!==null){
                        if (val===-1){ cell.textContent="üè†"; cell.style.background="#8B7355"; }
                        else if (val === 2) {
    cell.style.position = "relative";
    cell.style.fontSize = "0"; // piilota oletuskoko
    cell.style.background="rgba(200,200,200,0.6)";
    cell.innerHTML = `
        <span style="
            position:absolute;
            left:2px;
            top:1px;
            font-size:8px;
        ">üêë</span>

        <span style="
            position:absolute;
            right:2px;
            bottom:1px;
            font-size:8px;
        ">üêë</span>
    `;
}

                        else if (val===1){ cell.textContent=(i===5?"üêê":"üêë"); cell.style.background="rgba(200,200,200,0.6)"; }
                        else cell.style.background="rgba(200,200,200,0.4)";
                    }
                }

                grid.appendChild(cell);
            }
        }

        btn.appendChild(grid);

        const lbl = document.createElement("div");
        lbl.textContent = PIECE_NAMES[i];
        lbl.style.marginTop = "4px";
        btn.appendChild(lbl);

 // ‚Äì Kulmaikoni: üîí (esiasetettu) tai ‚úì (asennettu)
const icon = document.createElement("div");
icon.style.position = "absolute";
icon.style.top = "-15px";
icon.style.right = "-18px";
icon.style.fontSize = "18px";
icon.style.color = "black";
icon.style.zIndex = "5";

if (gameState.lockedPieces.has(i)) {
    icon.textContent = "üîí";
} else if (usedPieces.has(i)) {
    icon.textContent = "\u2713";
}

// ‚Äì Lis√§√§ ikoni GRIDIN sis√§√§n, ei nappiin
grid.appendChild(icon);


btn.onclick = () => {
    if (gameState.selectedPiece === i) {
        // Sama pala on jo valittuna ‚Üí k√§√§nn√§ 90¬∞
        gameState.selectedRotation = (gameState.selectedRotation + 1) % 4;
    } else {
        // Pala valitaan ensimm√§ist√§ kertaa ‚Üí ei k√§√§nt√∂√§
        gameState.selectedPiece = i;
        gameState.selectedRotation = 0;
    }

    renderPieces();
};


        selector.appendChild(btn);
    }
}
/* ----------------------------------------------------
   COUNTING / CORNERS
---------------------------------------------------- */

function countSheepByArea(){
    const counts = { tl:0, tr:0, bl:0, br:0 };
    const hasGoat = { tl:false, tr:false, bl:false, br:false };

    for (let i=0; i<25; i++){
        const item = gameState.board[i];
        if (!item || item.value <= 0) continue; // lasketaan vain 1 ja 2

        const row = Math.floor(i / 5);
        const col = i % 5;

        const area = AREA_MAP[row][col];
        if (area === 'b') continue;

        counts[area] += item.value;

        // ‚úÖ Vuohi = pala id 5, sen pit√§√§ olla siin√§ kulmassa jos targetissa on B
        if (item.id === 5) {
            hasGoat[area] = true;
        }
    }

    return { counts, hasGoat };
}


function updateCorners(){
const { counts } = countSheepByArea();

    const areas = ['tl','tr','bl','br'];

    areas.forEach(a => {
        const el = document.getElementById(a);
        const tgt = PUZZLE.targets[a];

        // Korvataan B -> üêë
        let shownTarget = tgt;
        if (typeof shownTarget === "string") {
            shownTarget = shownTarget.replace(/B/g, "üêê");
        }

        el.textContent = counts[a] + "/" + shownTarget;
    });
}


/* ----------------------------------------------------
   WIN CHECK
---------------------------------------------------- */
function removePiece() {
    const pid = gameState.selectedPiece;

    if (!pid) {
        updateStatus("Valitse ensin pala jonka haluat poistaa.");
        return;
    }

    // Esiasetettu pala?
    if (gameState.lockedPieces.has(pid)) {
        updateStatus("T√§t√§ esiasetettua palaa ei voi poistaa.");
        return;
    }

    // Tarkista, onko pala ylip√§√§t√§√§n laudalla
    let found = false;
    for (let i = 0; i < 25; i++) {
        if (gameState.board[i] && gameState.board[i].id === pid) {
            gameState.board[i] = null;
            found = true;
        }
    }

    if (!found) {
        updateStatus("Valittua palaa ei ole laudalla.");
        return;
    }

    updateStatus("Pala poistettu.");
    renderBoard();
    renderPieces();
}


function checkWin(){
    // 1) Ker√§t√§√§n, mitk√§ palat ovat laudalla
    const used = new Set();
    for (let i = 0; i < 25; i++) {
        if (gameState.board[i]) used.add(gameState.board[i].id);
    }

    // ‚úÖ Ensin: kaikkien 8 palan on oltava laudalla
    if (used.size !== 8) return;

    // 2) Lasketaan kulmat + vuohen sijainti
    const { counts, hasGoat } = countSheepByArea();

    // 3) Tarkistetaan kulmat
    let allGood = true;

    for (const a of ['tl','tr','bl','br']) {
        let target = PUZZLE.targets[a];

        if (target == null) continue;
        if (target === '?') continue;

        const needsGoat = (typeof target === 'string') && target.includes('B');

        // poimitaan numero-osa
        if (typeof target === 'string') {
            const m = target.match(/\d+/);
            if (!m) continue;
            target = parseInt(m[0], 10);
        }

        if (counts[a] !== target) {
            allGood = false;
        }

        // ‚úÖ Vuohi pit√§√§ olla t√§ss√§ kulmassa jos targetissa on B
        if (needsGoat && !hasGoat[a]) {
            allGood = false;
        }
    }

    if (!allGood) {
        updateStatus("‚ùå Ratkaisu ei ole oikein!");
        document.getElementById('status').classList.remove('success');
        return;
    }

    updateStatus("üéâ PULMA RATKAISTU! üéâ");
    document.getElementById('status').classList.add('success');
}




/* ----------------------------------------------------
   STATUS
---------------------------------------------------- */

function updateStatus(msg){
    const el = document.getElementById('status');
    el.textContent=msg;
    el.classList.remove('success');
}

/* ----------------------------------------------------
   INIT
---------------------------------------------------- */


// --- Vaikeustason valinta (UI) ---
(function initDifficultySelect(){
    const sel = document.getElementById("difficultySelect");
    if (!sel) return;

    // oletus: helppo
    sel.value = currentDifficulty;

    sel.addEventListener("change", () => {
        currentDifficulty = sel.value;

        // Vaihdetaan tasoa ‚Üí arvotaan heti uusi pulma valitusta haarukasta
        if (puzzlesLoaded) {
            applyRandomPuzzleFromDifficulty();
        } else {
            loadPuzzles(); // loadPuzzles() kutsuu lopuksi applyRandomPuzzleFromDifficulty()
        }
    });
})();

loadPuzzles();

/* SERVICE WORKER */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('./service-worker.js')
      .catch(err => console.warn('Service workerin rekister√∂inti ep√§onnistui:', err));
  });
}

</script>

<!-- QR Koodi yms‚Ä¶ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
  #qrOverlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);z-index:999;
  }
  #qrBox{
    background:#fff;padding:16px 20px;border-radius:12px;text-align:center;
    box-shadow:0 0 20px rgba(0,0,0,.4);
  }
  #qrBox canvas{width:180px;height:180px;}
</style>

<div id="qrOverlay">
  <div id="qrBox">
    <canvas id="qr"></canvas>
    <p>ymouse91.github.io/laskelampaita/</p>
  </div>
</div>

<script>
const qr=new QRious({
  element:document.getElementById('qr'),
  value:'https://ymouse91.github.io/laskelampaita/',
  size:180
});
const overlay=document.getElementById('qrOverlay');
document.getElementById('title').onclick=()=>overlay.style.display='flex';
overlay.onclick=()=>overlay.style.display='none';
</script>
</body>
</html>